<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>En Sade Sözlük</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 600px;
            margin: 40px auto;
            background-color: #f9f9f9;
        }

        #txtKelime {
            width: 70%;
            padding: 12px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        #btnAra {
            width: 25%;
            padding: 12px;
            font-size: 16px;
            border: none;
            background-color: #007bff;
            color: white;
            border-radius: 5px;
            cursor: pointer;
        }

        #sonucAlani {
            margin-top: 20px;
            padding: 20px;
            background-color: #fff;
            border: 1px solid #eee;
            border-radius: 5px;
            min-height: 50px;
            line-height: 1.6;
        }

        h2 {
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
    </style>
</head>

<body>
    <div style="text-align: right; padding: 10px;">
        <span id="panelGirisYok">
            <a href="/giris.html" style="text-decoration:none; color: #007bff;">Giriş Yap / Kayıt Ol</a>
        </span>

        <div id="panelKullanici" style="display: none; text-align: right;">
            <div style="margin-bottom: 10px;">
                <button onclick="favorileriGoster()">❤️ Favoriler</button>
                <button onclick="formuGosterGizle()" style="background-color: #f39c12;">🔑 Şifre Değiştir</button>
                <button onclick="hesapSil()" style="background-color: #dc3545;">⚠️ Hesabı Sil</button>
                <button onclick="cikisYap()">Çıkış</button>
            </div>

            <div id="sifreDegistirmeFormu" style="display: none; background: #eee; padding: 10px; border-radius: 5px; margin-top: 10px; text-align: left;">
                <h4>Şifre Güncelleme</h4>
                <input type="password" id="txtEskiSifre" placeholder="Mevcut Şifreniz" style="width: 90%; margin-bottom: 5px;">
                <input type="password" id="txtYeniSifre" placeholder="Yeni Şifreniz" style="width: 90%; margin-bottom: 5px;">
                <br>
                <button onclick="sifreGuncelle()" style="background-color: #27ae60;">Kaydet</button>
                <button onclick="formuGosterGizle()" style="background-color: #7f8c8d;">İptal</button>
            </div>
        </div>
    </div>

    <h2>Hızlı Sözlük</h2>

    <p>Aradığınız kelimenin anlamını, dikkat dağıtıcı hiçbir unsur olmadan anında öğrenin.</p>

    <input type="text" id="txtKelime" placeholder="Kelime girin..." />

    <button id="btnAra">Ara</button>

    <hr style="border: none; border-top: 1px solid #eee; margin-top: 25px;">

    <div id="sonucAlani">
        ...
    </div>

    <button id="btnFavori" style="display:none; margin-top:15px; width:100%; padding:10px; background:#ffc107; border:none; border-radius:5px; cursor:pointer;">
        ⭐ Bu Kelimeyi Favorilere Ekle
    </button>

    <div id="favoriListesiAlani" style="margin-top:30px; display:none; border-top:1px solid #eee; padding-top:20px;">
        <h3>Favorilerim</h3>
        <ul id="liste" style="list-style:none; padding:0;"></ul>
    </div>

    <script>
        const kelimeKutusu = document.getElementById("txtKelime");
        const araButonu = document.getElementById("btnAra");
        const sonucAlani = document.getElementById("sonucAlani");
        const btnFavori = document.getElementById("btnFavori");
        const panelGirisYok = document.getElementById("panelGirisYok");
        const panelKullanici = document.getElementById("panelKullanici");

        // Kullanıcı giriş yapmış mı kontrol et
        const kullaniciId = localStorage.getItem("sozluk_uid");
        if (kullaniciId) {
            panelGirisYok.style.display = "none";
            panelKullanici.style.display = "block";
        }

        araButonu.addEventListener("click", aramaYap);
        kelimeKutusu.addEventListener("keypress", function (e) { if (e.key === "Enter") aramaYap(); });

        // Global değişkenler (Favori eklerken kullanmak için)
        let sonArananKelime = "";
        let sonBulunanAnlam = "";

        async function aramaYap() {
            var kelime = kelimeKutusu.value.trim();
            if (kelime === "") return;

            // Ekranı temizle
            sonucAlani.innerText = "Aranıyor...";
            btnFavori.style.display = "none";
            document.getElementById("favoriListesiAlani").style.display = "none";

            try {
                const response = await fetch('/api/sozluk/' + kelime);
                if (response.ok) {
                    const anlam = await response.text();
                    sonucAlani.style.color = "#000";
                    sonucAlani.innerText = anlam;

                    // Kelime bulunduysa değişkenlere ata
                    sonArananKelime = kelime;
                    sonBulunanAnlam = anlam;

                    // SADECE kullanıcı giriş yapmışsa butonu göster
                    if (kullaniciId) {
                        btnFavori.style.display = "block";
                    }
                } else {
                    sonucAlani.style.color = "#b22222";
                    sonucAlani.innerText = "Kelime bulunamadı.";
                }
            } catch (error) {
                sonucAlani.innerText = "Hata: " + error.message;
            }
        }

        // Favori Ekleme Fonksiyonu
        btnFavori.addEventListener("click", async function () {
            if (!kullaniciId) return; // Güvenlik

            const veri = {
                KullaniciId: parseInt(kullaniciId),
                Kelime: sonArananKelime,
                Anlam: sonBulunanAnlam
            };

            const response = await fetch('/api/favori/ekle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(veri)
            });

            if (response.ok) alert("Favorilere eklendi!");
            else alert(await response.text());
        });

        // Favorileri Listeleme
        async function favorileriGoster() {
            const div = document.getElementById("favoriListesiAlani");
            const liste = document.getElementById("liste");
            div.style.display = "block";
            liste.innerHTML = "Yükleniyor...";

            const response = await fetch('/api/favori/listele/' + kullaniciId);
            const veriler = await response.json();

            liste.innerHTML = "";
            veriler.forEach(fav => {
                const li = document.createElement("li");
                li.style.marginBottom = "10px";
                li.style.borderBottom = "1px solid #eee";
                li.innerHTML = `<b>${fav.kelime}</b>: ${fav.anlam.substring(0, 50)}... <button onclick="favoriSil(${fav.id})" style="color:red; border:none; background:none; cursor:pointer;">Sil</button>`;
                liste.appendChild(li);
            });
        }

        async function favoriSil(id) {
            if (confirm("Silmek istediğine emin misin?")) {
                await fetch('/api/favori/sil/' + id, { method: 'DELETE' });
                favorileriGoster(); // Listeyi yenile
            }
        }

        async function hesapSil() {
            // 1. Kullanıcıdan onay al
            if (!confirm("DİKKAT! Hesabınız ve tüm favorileriniz kalıcı olarak silinecek. Emin misiniz?")) {
                return; // Vazgeçti
            }

            if (!kullaniciId) return;

            // 2. API'ye silme isteği gönder
            try {
                const response = await fetch('/api/kullanici/sil/' + kullaniciId, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert("Hesabınız silindi. Üzüldük :( Ana sayfaya yönlendiriliyorsunuz.");
                    // 3. Tarayıcı hafızasını temizle ve çıkış yap
                    localStorage.removeItem("sozluk_uid");
                    localStorage.removeItem("sozluk_kadi"); // Eğer kaydettiysen
                    window.location.reload();
                } else {
                    alert("Hata oluştu: " + await response.text());
                }
            } catch (err) {
                alert("Bağlantı hatası: " + err.message);
            }
        }

        function cikisYap() {
            localStorage.removeItem("sozluk_uid");
            window.location.reload();
        }

        // Şifre formunu açıp kapatmaya yarayan basit fonksiyon
        function formuGosterGizle() {
            const form = document.getElementById("sifreDegistirmeFormu");
            if (form.style.display === "none") {
                form.style.display = "block";
            } else {
                form.style.display = "none";
                // Kapatırken içini temizleyelim
                document.getElementById("txtEskiSifre").value = "";
                document.getElementById("txtYeniSifre").value = "";
            }
        }

        // Backend'e isteği gönderen fonksiyon
        async function sifreGuncelle() {
            const eskiSifre = document.getElementById("txtEskiSifre").value;
            const yeniSifre = document.getElementById("txtYeniSifre").value;

            if (!eskiSifre || !yeniSifre) {
                alert("Lütfen tüm alanları doldurun.");
                return;
            }

            try {
                const response = await fetch('/api/kullanici/sifre-degistir', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        KullaniciId: localStorage.getItem('sozluk_uid'), // ID'yi localstorage'dan alıyoruz
                        EskiSifre: eskiSifre,
                        YeniSifre: yeniSifre
                    })
                });

                if (response.ok) {
                    alert("Şifreniz başarıyla değiştirildi!");
                    formuGosterGizle(); // Formu kapat
                } else {
                    // Backend'den gelen hatayı göster (Örn: Eski şifre yanlış)
                    const hataMesaji = await response.text();
                    alert("Hata: " + hataMesaji);
                }
            } catch (err) {
                alert("Bir sorun oluştu: " + err);
            }
        }
    </script>

</body>
</html>